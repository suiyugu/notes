## Exposing the Rat in the Tunnel: Using Traffic Analysis for Tor-based Malware Detection

### intro

tor 由于其匿名性，野外发现数百个恶意软件二进制文件依赖于它来隐藏它们的存在并阻碍命令与控制(C&C)的拆除操作。

[^野外]: 在实际环境中或现实世界中被发现，而不是在实验室或受控环境中。这些恶意软件文件**已经被分发到真实的用户设备或网络中**，或者它们已经在实际网络攻击中被检测到。
[^C&C]: Command and Control 一种网络架构或通信模式，用于控制和协调恶意软件（如病毒、蠕虫、僵尸网络等）的活动。C&C系统由恶意软件的作者或控制者使用，以便他们能够向感染的计算机发送指令，控制其行为，并收集有关这些计算机的信息。**监测和摧毁C&C**通常是网络安全工作者的一个重要任务。



##### 本文工作：

提出有效的流量分析，**准确识别基于TOR的恶意软件通信**

收集 数百个基于TOR的恶意软件二进制文件

检查 47,000多个活跃的加密恶意软件连接，并将它们与良性浏览流量进行比较

###### 挑战

- 检测zero-day恶意软件
- 创建真实恶意软件连接的大规模真实数据集比在其他领域更具挑战性
- 必须区分良性和恶意的Tor连接，不会中断合法用户对Tor的使用

###### 创新：

除了传统的流量分析功能(在连接级工作)

- 提出了**全局主机级**网络功能来捕获**跨主机日志**的特殊恶意软件通信指纹

  即使恶意软件连接在测试集中占Tor痕迹的比例不到5%，也以0.7%的FPR检测到“zero-day”恶意软件连接

- 使用**多标记方法**，能够准确地检测基于行为的恶意软件类(灰色软件，勒索软件等)

  在真实的企业日志中评估了模型的鲁棒性，并表明分类器即使缺少特征也可以识别受感染的主机

[^FPR]: False Positive Rate  负样本被错误分类占总数比例
[^zero-day]: 利用计算机系统或应用程序中尚未被发现或修补的安全漏洞或 "零日漏洞" 进行攻击

###### 未来

- **恶意软件沙盒技术**的改进可以改善数据和流量收集，这反过来可以解决研究问题，例如
  1. 能否从流量中识别每个恶意软件二进制文件
  2. 能否识别不同的二进制文件是否连接到相同的C&C(从而将它们链接到相同的操作符)
- 恶意软件可以通过在其操作中**添加良性流量**来阻止基于流量分析的检测，在这种情况下：
  1. 对抗性机器学习防御
  2. detection by ORs（洋葱路由器

### background and motivation

#### tor

用户通常会安装Tor浏览器，该浏览器在修改后的Firefox浏览器后面运行Onion Proxy（OP）

电路中三个OR：入口保护、中间、出口

OR和OP（Onion Proxy）通过路由器共识文档共享网络信息，包括OR名称、IP、连接端口、公钥和其他信息

Tor洋葱或隐藏服务（HS）提供服务器匿名性，与此同时，**它是C&C服务器的藏身之处，阻碍了拆除操作。**

如果外部服务器部署在可公开访问的机器上，则基于Tor的恶意软件通过3跳出口电路连接到C&C，如果外部服务作为隐藏或洋葱服务托管，则通过6跳HS电路连接到C＆C

![image-20231024115005643](https://gitee.com/sygu66/img/raw/master/image-20231024115005643.png)

用户达到HS（hideen sevrices）的方式：

- OP和二进制文件一起发货并安装
- Tor2Web

流量分析（尤其是WF（Web Filtering））：

- 攻击者使用Tor访问目标页面 收集网络跟踪
- 提取区分特征（分组序列、分组与突发之间的时序  训练监督分类器
- 受害者访问 对网站痕迹分类

检测基于Tor的恶意软件的挑战：

- 